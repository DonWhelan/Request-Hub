{"filter":false,"title":"insertModel.php","tooltip":"/model/insertModel.php","undoManager":{"mark":8,"position":8,"stack":[[{"start":{"row":0,"column":0},"end":{"row":0,"column":1},"action":"insert","lines":["<"],"id":1},{"start":{"row":0,"column":1},"end":{"row":0,"column":2},"action":"insert","lines":["?"]},{"start":{"row":0,"column":2},"end":{"row":0,"column":3},"action":"insert","lines":["p"]},{"start":{"row":0,"column":3},"end":{"row":0,"column":4},"action":"insert","lines":["h"]},{"start":{"row":0,"column":4},"end":{"row":0,"column":5},"action":"insert","lines":["p"]}],[{"start":{"row":0,"column":5},"end":{"row":1,"column":0},"action":"insert","lines":["",""],"id":2},{"start":{"row":1,"column":0},"end":{"row":2,"column":0},"action":"insert","lines":["",""]},{"start":{"row":2,"column":0},"end":{"row":3,"column":0},"action":"insert","lines":["",""]},{"start":{"row":3,"column":0},"end":{"row":3,"column":1},"action":"insert","lines":["?"]},{"start":{"row":3,"column":1},"end":{"row":3,"column":2},"action":"insert","lines":["."]}],[{"start":{"row":3,"column":1},"end":{"row":3,"column":2},"action":"remove","lines":["."],"id":3}],[{"start":{"row":3,"column":1},"end":{"row":3,"column":2},"action":"insert","lines":[">"],"id":4}],[{"start":{"row":1,"column":0},"end":{"row":2,"column":0},"action":"insert","lines":["",""],"id":5}],[{"start":{"row":2,"column":0},"end":{"row":19,"column":5},"action":"insert","lines":["// insertConnectionString() only has SELECT INSERT permission on its account on the MYSQL Server.    ","    function insertConnectionString($dir){","        // connection details are stored outside the web directory and are defined","        include($dir.\"../pem/sqlInsert.php\");","        $connection = mysqli_connect(iHOST, iUSER, iPASS);","        if (!$connection) {","            trigger_error(\"Could not reach database!<br/>\");","            include(\"logs/logsMail-1dir.php\");","            exit();","        }","        $db_selected = mysqli_select_db($connection, iDB);","        if (!$db_selected) {","            trigger_error(\"Could not reach database!<br/>\");","            include(\"logs/logsMail-1dir.php\");","            exit();","        } ","        return $connection;","    }"],"id":6}],[{"start":{"row":19,"column":5},"end":{"row":20,"column":0},"action":"insert","lines":["",""],"id":7},{"start":{"row":20,"column":0},"end":{"row":20,"column":4},"action":"insert","lines":["    "]},{"start":{"row":20,"column":4},"end":{"row":21,"column":0},"action":"insert","lines":["",""]},{"start":{"row":21,"column":0},"end":{"row":21,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":21,"column":4},"end":{"row":121,"column":8},"action":"insert","lines":["","    function insert_sqli($dir,$insert_query) {","        $connection = insertConnectionString($dir);","        $queryresult = mysqli_query($connection, $insert_query) ","        or die(mysqli_error($connection));","        mysqli_close($connection);","        return $queryresult;","    }","    ","    /* ","     *   insert_sqliLog() takes 3 arguments the query, the table and the expected amount of rows affected from that query","     *   if the effected number of rows does not match the what is thought, a security logs is created ","     *   The effected number of rows is calculated by compairing effected rows, and counting the rows before and after the insertion ","     */    ","    ","    function insert_sqliLog($dir,$insert_query, $table, $expectedResult) {","        $connection = insertConnectionString($dir);","        ","        $sql = \"Select * FROM $table\";","        $result = mysqli_query($connection,$sql); ","        $rowsBefore = mysqli_num_rows($result);","        ","        $queryresult = mysqli_query($connection, $insert_query) ","        or die(mysqli_error($connection));","        $affectedRows = mysqli_affected_rows($connection);","        ","        $sql = \"Select * FROM $table\";","        $result = mysqli_query($connection,$sql); ","        $rowsAfter = mysqli_num_rows($result);","         ","        if($rowsBefore != ($rowsAfter-$expectedResult) || $affectedRows != $expectedResult){","            include(\"logs/logsMail.php\");","        }","        mysqli_close($connection);","        return $queryresult;","    }","    ","    /*","     *   insert_sqliTransaction() takes 3 arguments the query, the table and the expected amount of rows affected from that query","     *   Before the query is run a transaction is started ","     *   if the effected number of rows does not match the what is thought, a security logs is created and the the transaction is rolled back","     *   The effected number of rows is calculated by compairing effected rows, and counting the rows before and after the insertion ","     *   If the effected number of rows does match what is thought, the query is commited","     */    ","    ","    function insert_sqliTransaction($dir, $insert_query, $table, $expectedResult) {","        $connection = insertConnectionString($dir);","        mysqli_autocommit($connection,FALSE);","        mysqli_query($connection,\"start transaction\"); ","        ","        $sql = \"Select * FROM $table\";","        $result = mysqli_query($connection,$sql); ","        $rowsBefore = mysqli_num_rows($result);","        ","        $queryresult = mysqli_query($connection, $insert_query) ","        or die(mysqli_error($connection));","        $affectedRows = mysqli_affected_rows($connection);","        ","        $sql = \"Select * FROM $table\";","        $result = mysqli_query($connection,$sql); ","        $rowsAfter = mysqli_num_rows($result);","         ","        if($rowsBefore != ($rowsAfter-$expectedResult) || $affectedRows != $expectedResult){","            include(\"logs/logsMail.php\");","            mysqli_query($connection,\"rollback\");","        }else{","            mysqli_query($connection,\"commit\");","        }","        mysqli_close($connection);","        return $queryresult;","    }","    ","    /*","     *   insert_prepared_imageUpload takes 6 arguments and querys a prepaired statment to call images","     *   exacutes the query and the takes the affeted rows","     *   checks the affected rows agains the expected rows","     *   returns true if affected rows are equal expected rows they match, and false if not","     */     ","    ","    function insert_prepared_imageUpload($dir, $ufilename, $uhash, $uowner, $uvirusFree, $expectedResult) {","        $connection = insertConnectionString($dir);","        // Check connection","        if ($connection->connect_error) {","            die(\"Connection failed: \" . $connection->connect_error);","        }","        $stmt = $connection->prepare(\"INSERT INTO images (filename, hash, owner, virusFree) VALUES (?,?,?,?)\");","        $filename = $ufilename;","        $hash = $uhash;","        $owner = $uowner;","        $virusFree = $uvirusFree;","        $stmt->bind_param(\"ssss\", $filename, $hash, $owner, $virusFree);","        $stmt->execute();","        $affectedRows = mysqli_stmt_affected_rows($stmt);","        // check expected result","        if($affectedRows != $expectedResult){","            //include(\"logs/logsMail.php\");","            return false;","        }else{","            return true;","        }","    }   "],"id":8}],[{"start":{"row":92,"column":4},"end":{"row":122,"column":0},"action":"remove","lines":["","    /*","     *   insert_prepared_imageUpload takes 6 arguments and querys a prepaired statment to call images","     *   exacutes the query and the takes the affeted rows","     *   checks the affected rows agains the expected rows","     *   returns true if affected rows are equal expected rows they match, and false if not","     */     ","    ","    function insert_prepared_imageUpload($dir, $ufilename, $uhash, $uowner, $uvirusFree, $expectedResult) {","        $connection = insertConnectionString($dir);","        // Check connection","        if ($connection->connect_error) {","            die(\"Connection failed: \" . $connection->connect_error);","        }","        $stmt = $connection->prepare(\"INSERT INTO images (filename, hash, owner, virusFree) VALUES (?,?,?,?)\");","        $filename = $ufilename;","        $hash = $uhash;","        $owner = $uowner;","        $virusFree = $uvirusFree;","        $stmt->bind_param(\"ssss\", $filename, $hash, $owner, $virusFree);","        $stmt->execute();","        $affectedRows = mysqli_stmt_affected_rows($stmt);","        // check expected result","        if($affectedRows != $expectedResult){","            //include(\"logs/logsMail.php\");","            return false;","        }else{","            return true;","        }","    }   ",""],"id":9}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":3,"column":42},"end":{"row":4,"column":42},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1523203900141,"hash":"b514e1607ca0813c4fd0ffd725aaab5b94a646d9"}